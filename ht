<template>
    <div class="content-body">
                <!-- Dashboard Analytics Start -->

                <div class="content-header row">
                    <div class="content-header-left col-md-9 col-12 mb-2">
                        <div class="row breadcrumbs-top">
                            <div class="col-12">
                                <h2 class="content-header-title float-left mb-0">سجل المدني</h2>
                                <div class="breadcrumb-wrapper">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="index.html">استعلام</a>
                                        </li>
                                        <li class="breadcrumb-item"><a href="#">المواطنين</a>
                                        </li>

                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
           
                </div>

                <section class="tooltip-validations" id="tooltip-validation">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4 class="card-title">بحث السجل المدني</h4>
          </div>
          <div class="card-body">
            <form @submit.prevent="submitForm">
              <div class="form-row" style="margin-right: 3%;">
                <div class="col-md-4 col-12 mb-3">
                  <label for="validationTooltip03">رقم الهوية</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="validationTooltip02"
                      placeholder="رقم الهوية" v-model="cardId">
                    <div class="input-group-append" id="button-addon2">
                      <button class="btn btn-outline-primary waves-effect" type="button">
                       </button>
                    </div>
                  </div>
                </div>

                <div class="col-md-4 col-12 mb-3">
                  <label for="">الاسم كامل </label>
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder=" الاسم الاول" v-model="firstName">
                    <input type="text" class="form-control" placeholder=" اسم الاب" v-model="fatherName">
                    <input type="text" class="form-control" placeholder=" اسم الجد " v-model="grandfatherName">
                    <input type="text" class="form-control" placeholder=" اسم العائلة " v-model="familyName">
                  </div>
                </div>

                <div class="col-md-4 col-12  mb-3 demo-inline-spacing">
                  <button id="type-warning" class="btn btn-primary" style="margin-top: 24px;" type="submit">
                    بحث 
                    <!-- Your SVG Here -->
                  </button>

                  <button type="button" class="btn btn-secondary waves-effect waves-float waves-light" @click="clearInput">
                    تنظيف   
                    <i class="fas fa-times clear-icon"></i>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
                </section>
          
<section id="multilingual-datatable">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header border-bottom">
                    <h4 class="card-title">عرض النتائج</h4>
                </div>
                <div class="card-datatable">
                    <table class="table dataTable">
                        <thead>
                            <tr>
                                 <th style="text-align: center;">رقم الهوية</th>
                                <th style="text-align: center;">الاسم الاول </th>
                                <th style="text-align: center;">الأب   </th>
                                <th style="text-align: center;">  الجد </th>
                                <th style="text-align: center;">  العائلة </th>
                                <th style="text-align: center;">رقم هاتف </th>
                                <th style="text-align: center;">النوع</th>
                                <th style="text-align: center;">  تاريخ الميلاد </th>
                                 <th style="text-align: center;">اجراء   </th>

                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(result, index) in paginatedData" :key="index">
                                <td>{{ result.CIT_NO }}</td>
                                <td>{{ result.CIT_FIRST }}</td>
                                <td>{{ result.CIT_FATHER }}</td>
                                <td>{{ result.CIT_GRANDF }}</td>
                                <td>{{ result.CIT_FAMLY }}</td>
                                <td>{{ toInt(result.MOBILE) }}</td>
                                <td>{{ result.RAT_NM }}</td>
                                <td>{{ result.BIRTH_DT }}</td>
                               
                                <button class="btn btn-primary" data-toggle="modal" data-target="#large" @click="openDetailsModal(result)">عرض التفاصيل</button>
                            </tr>
                        </tbody>
                        <div>
        <button @click="previousPage">السابق</button>

        <button
            v-for="n in totalPages"
            :key="n"
            @click="currentPage = n"
            :class="{ 'is-active': n === currentPage }"
        >
            {{ n }}
        </button>

        <button @click="nextPage">التالي</button>
    </div>
                    </table>

                   
                </div>
            </div>
        </div>
    </div>
</section>

            <div class="modal fade text-left" id="large" tabindex="-1" role="dialog" aria-labelledby="myModalLabel17" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel17"> بيانات الكلية للقضية</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
 
                            <div class="row" id="table-hover-row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h4 class="card-title"> بيانات القضية</h4>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                              
                              
                   
                                                <div class="col-xl-6 col-md-6 col-12">
                                                    <div class="form-group">
                                                        <label for="disabledInput">نوع القضة </label>
                
                                                        <input type="text" class="form-control" id="readonlyInput" readonly="readonly"     :value="selectedItem?selectedItem.RAT_NM: ''"  >                                                    </div>
                                                </div>
                
                
                                                <div class="col-xl-6 col-md-6 col-12">
                                                    <div class="form-group">
                                                        <label for="disabledInput"> مكان الحدث</label>
                                                        <input type="text" class="form-control" id="readonlyInput" readonly="readonly"     :value="selectedItem?selectedItem.DEP_NM: ''"  >                                                     </div>
                                                </div>
                
                                                <div class="col-12">
                                                    <div class="form-group">
                                                        <label for="exampleFormControlTextarea1">ملخص القضية</label>
                                                        <textarea class="form-control" id="exampleFormControlTextarea1" rows="3" readonly="readonly" :value="selectedItem?selectedItem.INV_SUMMARY: ''" >ملخص القضية</textarea>
                                                    </div>
                                                </div>
                
                
                                   
                                 
                                            </div>
                                        </div>

                                        
                                
                                    </div>
                                </div>
                            </div>


                            <div class="row" id="table-hover-row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h4 class="card-title"> الاشخاص الموجودين بلقضية</h4>
                                        </div>
                                        <div class="card-body">
                                        
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-hover" style="    text-align: center;                                            ">
                                                <thead>
                                                    <tr>
                                                        <th>الاسم</th>
                                                        <th>الصفة</th>
                                                        
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td><strong>محمد جميل </strong></td>
                                                       
 
                                                        <td><span class="badge badge-pill badge-light-danger mr-1" >مشتكي ضده</span></td>

                                                
                                                    </tr>
                                                    <tr>
                                                        <td><strong>محمد نبيل </strong></td>

  
                                                        <td><span class="badge badge-pill badge-light-primary mr-1">مشتكي</span></td>
                                                        
                                                    </tr>


                                                    <tr>
                                                        <td><strong>محمد جميل </strong></td>
                                                       
 
                                                        <td><span class="badge badge-pill badge-light-danger mr-1">مشتكي ضده</span></td>

                                                
                                                    </tr>
                                                    
                                             
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal">اغلاق</button>
                        </div>
                    </div>
                </div>
            </div>
 

            </div>
</template>
<script>
import axios from 'axios';
import Swal from 'sweetalert2';

export default {
    data() {
        return {
            searchResults: [],
            currentPage: 1,
            perPage: 7,
            rows: 0,
         
            cardId: "800298143",
            firstName: "",
            fatherName: "",
            grandfatherName: "",
            familyName: "",

            selectedItem:""
        }
    },
    computed: {
        paginatedData() {
        const start = (this.currentPage - 1) * this.perPage;
        const end = start + this.perPage;
        return this.searchResults.slice(start, end);
    },
    totalPages() {
        return Math.ceil(this.searchResults.length / this.perPage);
    }
    },
    methods: {
        toInt(n){
return Math.floor(n);
        },
        async nextPage() {
    if (this.currentPage < this.totalPages) {
        try {
            this.currentPage++;
            await this.submitForm();
            console.log(this.currentPage);
        } catch (error) {
            this.currentPage--;   
        }
    }
},
async previousPage() {
    if (this.currentPage > 1) {
        try {
            this.currentPage--;
            await this.submitForm();
            console.log(this.currentPage);
        } catch (error) {
            this.currentPage++;   
        }
    }
},
    async submitForm() {
    try {
        let url = 'http://127.0.0.1:8000/api/data';
        if (this.cardId) {
            url += `?card_id=${this.cardId}&page_size=${this.perPage}&page_number=${this.currentPage}`;
        } else {
            if (!this.firstName || !this.familyName) {
                Swal.fire({
                  icon: 'error',
                  title: 'تنبيه',
                  text: 'على الاقل يجب ارفاق الاسم الاول واسم العائلة في حال لا يوجد لديك رقم هوية',
                });
                return;
            }
            url += `?first_name=${this.firstName}&father_name=${this.fatherName}&grandfather_name=${this.grandfatherName}&family_name=${this.familyName}&page_size=${this.perPage}&page_number=${this.currentPage}`;
        }

        const response = await axios.get(url);
console.log(url);
        if(response.data && response.data.data) {
            this.searchResults = response.data.data.map(item => {
                return {
                    ...item,
                    fullName: `${item.CIT_FIRST} ${item.CIT_FATHER} ${item.CIT_GRANDF} ${item.CIT_FAMLY}`,
                    details: 'DETAILS_LINK_OR_MODAL_TRIGGER'
                };
            });

            console.log(this.searchResults);
            this.rows = response.data.total ? response.data.total : this.searchResults.length; 
            this.currentPage = Math.ceil(this.searchResults.length / this.perPage);

        }
    } catch (error) {
        console.error(error);
    }
},


 
openDetailsModal(result) {
            this.selectedItem = result;

 
              
        },
        handlePageChange() {
            this.submitForm();
        },
        clearInput() {
            this.idNumber = '';
            this.firstName = '';
            this.fatherName = '';
            this.grandfatherName = '';
            this.lastName = '';
            this.searchResults = [];
            this.currentPage = 1;
            this.rows = 0;
        }
    }
};
</script>

<style>
button.is-active {
    background-color: #007bff;
    color: white;
}
</style>
 

